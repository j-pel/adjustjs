<html>
	<head>
    <meta charset='utf-8'>
		<title>Simple example for couching with CouchDB</title>
	</head>
  <style>
  pre.code {
    font-size: 9pt;
    padding: 2px;
    border: 1px solid #aaa;
    border-left: 10px solid #aaa;
  }
  </style>
  <body>
    <h1>Couching.js</h1>
    <p>This is an easy to use and fully asynchronous frontend to manage a CouchDB instance using ES6 promises.</p>
    <h2>How to use</h2>
    <p>The following is a step by step guide to test the functionality included in couching.js. Just press the "Next" button to start.</p>
    <table>
      <tr><td>CouchDB connection:</td><td>Admin user:</td><td>Password:</td><td></td>
      </tr>
      <tr>
        <td>
          <input id="database" size=32
            placeholder="http://localhost:5984/test"
            value="http://192.168.1.54:5984/test" />
        </td>
        <td>
          <input id="username"  size=12
            placeholder="admin" value="jorge" />
        </td>
        <td>
          <input id="password"  size=12
            type="password" value="" />
        </td>
        <td>
          <button id="next" onclick="next();">Next</button>

        </td>
        <td style="width: 100%"><button id="restart" style="display: none;" onclick="restart();">Restart</button>&nbsp;</td>
      </tr>
      <tr>
        <td colspan=6>
          <h3 id="title">Before starting</h3>
          <p id="description">Couching requires access to an Apache CouchDB or API compatible databases. It is very easy to install and start a CouchDB instance. Otherwise, it is possible to run CouchDB as a service from some cloud providers. Some of them are free for low traffic applications.<br />
          Couching initializer returns an object instance with the database name and uri. If the database do not exist, it must be created before using it. Only an administrator can create one. A login is needed.</p>
        </td>
      </tr>
      <tr>
        <td colspan=2><fieldset style="height: 220px;">
          <legend>code</legend>
          <pre class=code id=code>cdb = Couching(database.value);
show(cdb)
          </pre></fieldset>
        </td>
        <td colspan=4><fieldset style="height: 220px;">
          <legend>show() output</legend>
          <pre id='result'></pre></fieldset>
        </td>
      </tr>
    </table>

    <table id="test_field" style="width:100%;"></table>
    <script type="text/javascript" src="../couching.js"></script>
    <!--script type="text/javascript" src="http://www.gerd-tentler.de/tools/codeview/codeview.js"></script-->
    <script type="text/javascript">

var cdb = Couching(database.value);

var test = 0;
var tests = [
{
  title: "Logging in",
  description:"With proper user credentials, the login call will be succesful and the roles the logged in user has became accessible. In order to create a database, the user must have admin role.",
  code: "cdb.login({ \n\
  name: username.value, \n\
  password: password.value \n\
}).then(function(data){ \n\
  show(data); \n\
}).catch(function(err){ \n\
  show(err); \n\
});"
},{
  title: "Creating",
  description:"If the user logged in in the previous step has admin role defined, the call to create the database is succesful, otherwise the test fails and none of the succesive steps could proceed.",
  code: "cdb.create().then(function(value){ \n\
  show(value); \n\
}).catch(function(err){ \n\
  show(err); \n\
});"
},{
  title: "Storing with put",
  description:"The put call is used to store a document into the database. If the document has an _id defined and a document with the same _id is found already in the database, the result is a revised, merged document. If the document _id is new, the document is stored as is. If no _id is provided, the document is stored with a given unique _id.",
  code: "cdb.put({_id: 'test1',prop: 12}).then(function(value){ \n\
  show(value); \n\
}).catch(function(err){ \n\
  show(err); \n\
});"
},{
title:"Storing with post",
description:"The post call is used to store new documents into the database. If an _id is given, it is discarded and a new, unique _id is given instead.",
code:"cdb.post({_id:'test2', prop:6}).then(function(value){ \n\
  show(value); \n\
}).catch(function(err){ \n\
  show(err); \n\
});"
},{
  title: "Retrieving",
  description:"The get call is used to retrieve a document from the database knowing its _id.",
  code: "cdb.get('test1').then(function(value){ \n\
  show(value); \n\
}).catch(function(err){ \n\
  show(err); \n\
});"
},{
  title: "Head call",
  description:"A head call is the least intensive call to the database. It retrieves just the header, containing the document revision.",
  code: "cdb.head('test1').then(function(value){ \n\
  show(value); \n\
}).catch(function(err){ \n\
  show(err); \n\
});"
},{
  title: "Storing a view",
  description:"A view is stored with a put call as any other document but with an special _id starting in '_design/'. A view is used to query the database by means of a Map/Reduce interface.",
  code: "cdb.put({ \n\
    _id: '_design/main', \n\
    views: { \n\
      index:{ \n\
        map:'function(doc){emit(doc);}' \n\
      } \n\
    }, \n\
    language: 'javascript' \n\
  }).then(function(value){ \n\
  show(value); \n\
}).catch(function(err){ \n\
  show(err); \n\
});"
},{
  title: "Querying",
  description:"The Map/Reduce interface is the mechanism used to query CouchDB databases. The Map function stored in the view will iterate through all documents in the database. The Reduce function will process all documents to obtain a single value.",
  code: "cdb.query(\"main/index\",{ \n\
  includeDocs: true, \n\
  descending: true, \n\
  limit: 10 \n\
}).then(function(data) { \n\
  show(data); \n\
}).catch(function(err) { \n\
  show(err); \n\
});"
},{
  title: "Clearing",
  description:"If the user logged in before has admin role, the call to clear the database is succesful, otherwise nothing happens. The database with all its contents is completely deleted.",
  code: "cdb.clear().then(function(value){ \n\
  show(value); \n\
}).catch(function(err){ \n\
  show(err); \n\
});"
}];

function next() {
  if (test==tests.length) {
    var but = document.getElementById("next");
    document.getElementById("restart").style.display = 'block';
    but.disable=true;
    return(0);
  }
  var current = tests[test];
  document.getElementById("title").innerText = "Test "+(test+1)+": "+current.title;
  document.getElementById("description").innerText = current.description;
  document.getElementById("code").innerText = current.code;
  eval(current.code);
  test++;
}

function restart() {
  test = 0;
  document.getElementById("restart").style.display = 'none';
  document.getElementById("next").disable = false;
  next();
}

function show(info) {
	var result = "";
  if (typeof(info)==='object') {
    for (var prop in info) {
      if (typeof(info[prop])!='function') {
        result += prop+ ": "+ info[prop] + "\n";
      }
    }
  } else {
    result += info + "\n";
  }
  document.getElementById('result').innerText = result;
}

    </script>
  </body>
</html>
